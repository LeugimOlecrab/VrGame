<!-- 
  WebXR Game: Shooter de Dianas con Sonido
  
  Esta versión incluye:
  - Efectos de sonido para disparos e impactos.
  - Lógica para detectar una doble pulsación en dispositivos móviles (Android, etc.)
    y disparar.
  - El mismo código funciona para clics de ratón y gatillos de VR.
  - Un entorno más atractivo, contador de puntuación y un rayo para simular el disparo.
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebXR Shooter</title>
    <!-- Se usa un enlace estable para A-Frame. -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!--
      Componente 'score-manager':
      Maneja el estado del juego: puntuación, contador de fallos, y fin del juego.
      También se encarga de crear y eliminar las dianas.
    -->
    <script>
        AFRAME.registerComponent('score-manager', {
            schema: {
                targetSpeed: {type: 'number', default: 1}
            },
            init: function() {
                this.score = 0;
                this.targets = [];
                this.missedCount = 0;
                this.maxMissed = 5;
                this.isGameOver = false;

                this.createScoreboard();
                this.createMissedCounter();
                this.createStartButton();
            },

            // Crea el botón para empezar el juego.
            createStartButton: function() {
                const button = document.createElement('a-entity');
                button.setAttribute('id', 'startButton');
                button.setAttribute('geometry', 'primitive: plane; width: 1; height: 0.5');
                button.setAttribute('material', 'color: green');
                button.setAttribute('position', '0 1.5 -3');
                button.setAttribute('text', {
                    value: '¡Empezar!',
                    align: 'center',
                    color: 'white',
                    width: 3
                });
                button.setAttribute('class', 'clickable');
                this.el.sceneEl.appendChild(button);

                button.addEventListener('click', () => {
                    this.startGame();
                });
            },

            startGame: function() {
                document.getElementById('startButton').setAttribute('visible', 'false');
                this.isGameOver = false;
                this.score = 0;
                this.missedCount = 0;
                this.updateScoreboard();
                this.updateMissedCounter();

                this.intervalId = setInterval(() => {
                    if (!this.isGameOver) {
                        this.createTarget();
                    } else {
                        clearInterval(this.intervalId);
                    }
                }, 2000);
            },

            // Crea una nueva diana.
            createTarget: function() {
                const target = document.createElement('a-entity');
                target.setAttribute('geometry', 'primitive: sphere; radius: 0.25');
                target.setAttribute('material', 'color: red');
                target.setAttribute('position', {x: (Math.random() - 0.5) * 4, y: 0.5, z: -20});
                target.setAttribute('class', 'target');
                target.setAttribute('animation-mixer', '');
                target.setAttribute('target-movement', 'speed: ' + this.data.targetSpeed);
                target.setAttribute('sound', 'src: #hit-sound; on: target-hit;');
                this.targets.push(target);
                this.el.sceneEl.appendChild(target);
            },

            // Actualiza la puntuación en la pantalla.
            updateScoreboard: function() {
                document.getElementById('scoreboard').setAttribute('text', 'value', 'Puntuación: ' + this.score);
            },

            // Actualiza el contador de fallos.
            updateMissedCounter: function() {
                document.getElementById('missedCounter').setAttribute('text', 'value', 'Fallos: ' + this.missedCount + ' / ' + this.maxMissed);
            },

            // Crea el marcador de puntuación.
            createScoreboard: function() {
                const scoreboard = document.createElement('a-entity');
                scoreboard.setAttribute('id', 'scoreboard');
                scoreboard.setAttribute('text', {
                    value: 'Puntuación: 0',
                    align: 'center',
                    width: 5
                });
                scoreboard.setAttribute('position', '0 2 -3');
                this.el.sceneEl.appendChild(scoreboard);
            },

            // Crea el contador de dianas falladas.
            createMissedCounter: function() {
                const counter = document.createElement('a-entity');
                counter.setAttribute('id', 'missedCounter');
                counter.setAttribute('text', {
                    value: 'Fallos: 0 / ' + this.maxMissed,
                    align: 'center',
                    width: 5,
                    color: 'yellow'
                });
                counter.setAttribute('position', '0 1.8 -3');
                this.el.sceneEl.appendChild(counter);
            },

            // Método público para gestionar un impacto en la diana.
            onTargetHit: function(targetEl) {
                if (this.isGameOver) return;
                
                // Reproduce el sonido de impacto.
                targetEl.emit('target-hit');

                targetEl.setAttribute('animation__scale', {
                    property: 'scale',
                    to: '0 0 0',
                    dur: 200
                });

                setTimeout(() => {
                    targetEl.parentNode.removeChild(targetEl);
                }, 200);
                this.score += 100;
                this.updateScoreboard();
            },

            tick: function() {
                if (this.isGameOver) return;

                // Movemos y verificamos las dianas.
                this.targets.forEach(target => {
                    const pos = target.getAttribute('position');
                    if (pos.z > 2) {
                        this.missedCount++;
                        this.updateMissedCounter();
                        target.parentNode.removeChild(target);
                        if (this.missedCount >= this.maxMissed) {
                            this.endGame();
                        }
                    }
                });
                this.targets = this.targets.filter(target => target.parentNode);
            },

            endGame: function() {
                this.isGameOver = true;
                clearInterval(this.intervalId);
                const gameOverText = document.createElement('a-entity');
                gameOverText.setAttribute('text', {
                    value: '¡Fin del juego!\nPuntuación final: ' + this.score,
                    align: 'center',
                    width: 5,
                    color: 'white'
                });
                gameOverText.setAttribute('position', '0 1.5 -3');
                this.el.sceneEl.appendChild(gameOverText);

                setTimeout(() => {
                    const restartButton = document.createElement('a-entity');
                    restartButton.setAttribute('geometry', 'primitive: plane; width: 1; height: 0.5');
                    restartButton.setAttribute('material', 'color: blue');
                    restartButton.setAttribute('position', '0 1 -3');
                    restartButton.setAttribute('text', {
                        value: 'Volver a empezar',
                        align: 'center',
                        color: 'white',
                        width: 3
                    });
                    restartButton.setAttribute('class', 'clickable');
                    this.el.sceneEl.appendChild(restartButton);

                    restartButton.addEventListener('click', () => {
                        location.reload();
                    });
                }, 2000);
            }
        });

        // Componente 'shooter-controller':
        // Maneja la lógica de disparo (clic de ratón, gatillo de VR o doble pulsación en móvil).
        AFRAME.registerComponent('shooter-controller', {
            schema: {
                doubleTapTime: {type: 'number', default: 300} // Milisegundos para considerar un doble toque.
            },
            init: function() {
                this.lastTap = 0;
                this.el.sceneEl.addEventListener('touchstart', this.handleTap.bind(this));
                this.el.sceneEl.addEventListener('mousedown', this.handleTap.bind(this));
            },
            
            handleTap: function(evt) {
                const currentTime = Date.now();
                const tapDifference = currentTime - this.lastTap;

                if (tapDifference < this.data.doubleTapTime) {
                    // Doble pulsación detectada en móvil o doble clic en ratón.
                    this.fireShot(evt);
                    this.lastTap = 0; // Reiniciamos el tiempo para evitar triples toques.
                } else {
                    // Primer toque.
                    this.lastTap = currentTime;
                }
            },

            // Dispara y verifica si se ha golpeado una diana.
            fireShot: function(evt) {
                // Reproduce el sonido de disparo.
                this.el.sceneEl.querySelector('[camera]').components.sound.playSound();

                const raycaster = this.el.components.raycaster;
                if (!raycaster || !raycaster.intersection) {
                    return; // No hay colisión, no hacemos nada.
                }

                const targetEl = raycaster.intersection.object.el;
                if (targetEl && targetEl.getAttribute('class') === 'target') {
                    // Si se ha golpeado una diana, llamamos al 'score-manager' para que lo procese.
                    const scoreManager = this.el.sceneEl.components['score-manager'];
                    scoreManager.onTargetHit(targetEl);
                }
            }
        });

        // Componente 'target-movement':
        // Mueve la diana en una trayectoria parabólica.
        AFRAME.registerComponent('target-movement', {
            schema: {
                speed: {type: 'number', default: 1}
            },
            init: function() {
                this.initialPos = this.el.getAttribute('position').clone();
                this.elapsedTime = 0;
            },
            tick: function(time, deltaTime) {
                this.elapsedTime += deltaTime / 1000;
                const newPos = {
                    x: this.initialPos.x,
                    y: this.initialPos.y + (this.elapsedTime * this.data.speed * 0.5) - (0.5 * 0.98 * this.elapsedTime * this.elapsedTime),
                    z: this.initialPos.z + (this.elapsedTime * this.data.speed * 2)
                };
                this.el.setAttribute('position', newPos);
            }
        });
    </script>
</head>
<body>
    <a-scene score-manager>
        <!-- Bloque de recursos. -->
        <a-assets>
            <audio id="shot-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/gun.mp3"></audio>
            <audio id="hit-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/click.mp3"></audio>
        </a-assets>

        <!-- Cámara del jugador. -->
        <a-entity id="rig" movement-controls position="0 1.6 0">
            <!-- Se añade el componente de sonido a la cámara. -->
            <a-entity camera look-controls sound="src: #shot-sound; volume: 0.5;"></a-entity>
            
            <!-- Simulación del "pistola" del controlador. -->
            <a-entity laser-controls="hand: right" raycaster="objects: .target; far: 100;" line="color: blue; opacity: 0.5" shooter-controller>
                <a-entity cursor="rayOrigin: mouse" raycaster="objects: .target; far: 100;"></a-entity>
            </a-entity>
        </a-entity>
        
        <!-- Entorno. -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4"></a-plane>
        <a-sky color="#ECECEC"></a-sky>

    </a-scene>
</body>
</html>
