<!-- 
  WebXR Game: Shooter de Dianas con Sonido
  
  Esta versión corrige los problemas de sonido e interacción, y ajusta la
  trayectoria de las dianas para que sean más altas y caigan más cerca.
  
  Características:
  - Efectos de sonido para disparos, impactos y caídas de dianas.
  - Lógica para detectar un solo toque o clic de ratón para disparar.
  - Un entorno más atractivo, contador de puntuación y un rayo para simular el disparo.
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebXR Shooter</title>
    <!-- Se usa un enlace estable para A-Frame. -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!--
      Componente 'game-logic':
      Maneja el estado del juego, la puntuación, el contador de fallos y el fin del juego.
      También se encarga de crear, eliminar y gestionar la interacción con las dianas.
      Esta es la nueva lógica central del juego.
    -->
    <script>
        AFRAME.registerComponent('game-logic', {
            schema: {
                targetSpeed: {type: 'number', default: 1}
            },
            init: function() {
                this.score = 0;
                this.targets = [];
                this.missedCount = 0;
                this.maxMissed = 5;
                this.isGameOver = false;

                // Creamos los elementos de la interfaz.
                this.createScoreboard();
                this.createMissedCounter();
                this.createStartButton();
                
                // Escuchamos el evento de clic en la escena para reproducir el sonido de disparo
                // y detectar si se ha impactado una diana.
                this.el.sceneEl.addEventListener('click', this.handleInteraction.bind(this));
            },

            // Maneja todos los clics y toques en la escena.
            handleInteraction: function(evt) {
                // Reproduce el sonido de disparo en cada clic o toque.
                this.el.sceneEl.querySelector('#shot-sound-player').components.sound.playSound();

                // Si el juego ha terminado, no hacemos nada con las dianas.
                if (this.isGameOver) {
                    return;
                }
                
                // Si hay una intersección, significa que el rayo ha impactado un objeto.
                if (evt.detail.intersection) {
                    const intersectedEl = evt.detail.intersection.object.el;

                    // Si el objeto es el botón de inicio, empezamos el juego.
                    if (intersectedEl.id === 'startButton') {
                        this.startGame();
                    } 
                    // Si el objeto es una diana, gestionamos el impacto.
                    else if (intersectedEl.getAttribute('class') && intersectedEl.getAttribute('class').includes('target')) {
                        this.onTargetHit(intersectedEl);
                    }
                }
            },

            // Crea el botón para empezar el juego.
            createStartButton: function() {
                const button = document.createElement('a-entity');
                button.setAttribute('id', 'startButton');
                button.setAttribute('geometry', 'primitive: plane; width: 1; height: 0.5');
                button.setAttribute('material', 'color: green');
                button.setAttribute('position', '0 1.5 -3');
                button.setAttribute('text', {
                    value: '¡Empezar!',
                    align: 'center',
                    color: 'white',
                    width: 3
                });
                button.setAttribute('class', 'clickable'); // Añadimos una clase para el raycaster.
                this.el.sceneEl.appendChild(button);
            },

            startGame: function() {
                // Ocultamos el botón de inicio.
                document.getElementById('startButton').setAttribute('visible', 'false');
                this.isGameOver = false;
                this.score = 0;
                this.missedCount = 0;
                this.updateScoreboard();
                this.updateMissedCounter();

                // Empezamos a generar dianas.
                this.intervalId = setInterval(() => {
                    if (!this.isGameOver) {
                        this.createTarget();
                    } else {
                        clearInterval(this.intervalId);
                    }
                }, 2000);
            },

            // Crea una nueva diana.
            createTarget: function() {
                const target = document.createElement('a-entity');
                target.setAttribute('geometry', 'primitive: sphere; radius: 0.35');
                target.setAttribute('material', 'color: red');
                target.setAttribute('position', {x: (Math.random() - 0.5) * 4, y: 0.5, z: -20});
                target.setAttribute('class', 'target clickable'); // Añadimos 'clickable' para el raycaster.
                target.setAttribute('animation-mixer', '');
                target.setAttribute('target-movement', 'speed: ' + this.data.targetSpeed);
                // El sonido de impacto se emite con un evento.
                target.setAttribute('sound', 'src: #hit-sound; on: target-hit;');

                this.targets.push(target);
                this.el.sceneEl.appendChild(target);
            },

            // Actualiza la puntuación en la pantalla.
            updateScoreboard: function() {
                document.getElementById('scoreboard').setAttribute('text', 'value', 'Puntuación: ' + this.score);
            },

            // Actualiza el contador de fallos.
            updateMissedCounter: function() {
                document.getElementById('missedCounter').setAttribute('text', 'value', 'Fallos: ' + this.missedCount + ' / ' + this.maxMissed);
            },

            // Crea el marcador de puntuación.
            createScoreboard: function() {
                const scoreboard = document.createElement('a-entity');
                scoreboard.setAttribute('id', 'scoreboard');
                scoreboard.setAttribute('text', {
                    value: 'Puntuación: 0',
                    align: 'center',
                    width: 5
                });
                scoreboard.setAttribute('position', '0 2 -3');
                this.el.sceneEl.appendChild(scoreboard);
            },

            // Crea el contador de dianas falladas.
            createMissedCounter: function() {
                const counter = document.createElement('a-entity');
                counter.setAttribute('id', 'missedCounter');
                counter.setAttribute('text', {
                    value: 'Fallos: 0 / ' + this.maxMissed,
                    align: 'center',
                    width: 5,
                    color: 'yellow'
                });
                counter.setAttribute('position', '0 1.8 -3');
                this.el.sceneEl.appendChild(counter);
            },

            // Gestiona el impacto de la diana.
            onTargetHit: function(targetEl) {
                // Reproduce el sonido de impacto.
                targetEl.emit('target-hit');

                targetEl.setAttribute('animation__scale', {
                    property: 'scale',
                    to: '0 0 0',
                    dur: 200
                });

                setTimeout(() => {
                    targetEl.parentNode.removeChild(targetEl);
                }, 200);
                this.score += 100;
                this.updateScoreboard();
            },

            tick: function() {
                if (this.isGameOver) return;

                // Movemos y verificamos las dianas.
                this.targets.forEach(target => {
                    const pos = target.getAttribute('position');
                    if (pos.z > 2) {
                        // Reproduce el sonido de caída.
                        this.el.sceneEl.querySelector('#fall-sound-player').components.sound.playSound();

                        this.missedCount++;
                        this.updateMissedCounter();
                        target.parentNode.removeChild(target);
                        if (this.missedCount >= this.maxMissed) {
                            this.endGame();
                        }
                    }
                });
                this.targets = this.targets.filter(target => target.parentNode);
            },

            endGame: function() {
                this.isGameOver = true;
                clearInterval(this.intervalId);
                const gameOverText = document.createElement('a-entity');
                gameOverText.setAttribute('text', {
                    value: '¡Fin del juego!\nPuntuación final: ' + this.score,
                    align: 'center',
                    width: 5,
                    color: 'white'
                });
                gameOverText.setAttribute('position', '0 1.5 -3');
                this.el.sceneEl.appendChild(gameOverText);

                setTimeout(() => {
                    const restartButton = document.createElement('a-entity');
                    restartButton.setAttribute('geometry', 'primitive: plane; width: 1; height: 0.5');
                    restartButton.setAttribute('material', 'color: blue');
                    restartButton.setAttribute('position', '0 1 -3');
                    restartButton.setAttribute('text', {
                        value: 'Volver a empezar',
                        align: 'center',
                        color: 'white',
                        width: 3
                    });
                    restartButton.setAttribute('class', 'clickable');
                    this.el.sceneEl.appendChild(restartButton);

                    restartButton.addEventListener('click', () => {
                        location.reload();
                    });
                }, 2000);
            }
        });

        // Componente 'target-movement':
        // Mueve la diana en una trayectoria parabólica.
        // Se ha ajustado la parábola para que sea más alta y las dianas caigan más cerca del jugador.
        AFRAME.registerComponent('target-movement', {
            schema: {
                speed: {type: 'number', default: 1}
            },
            init: function() {
                this.initialPos = this.el.getAttribute('position').clone();
                this.elapsedTime = 0;
            },
            tick: function(time, deltaTime) {
                this.elapsedTime += deltaTime / 1000;
                const newPos = {
                    x: this.initialPos.x,
                    // Se ha aumentado el impulso inicial en el eje Y para una parábola más alta.
                    y: this.initialPos.y + (this.elapsedTime * this.data.speed * 5.0) - (0.5 * 0.98 * this.elapsedTime * this.elapsedTime),
                    // Se ha reducido la velocidad en el eje Z para que caigan más cerca.
                    z: this.initialPos.z + (this.elapsedTime * this.data.speed * 0.3)
                };
                this.el.setAttribute('position', newPos);
            }
        });
    </script>
</head>
<body>
    <a-scene game-logic>
        <!-- Bloque de recursos. -->
        <a-assets>
            <!-- Se ha añadido preload="auto" para asegurar que los audios se carguen. -->
            <audio id="shot-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/gun.mp3" preload="auto"></audio>
            <audio id="hit-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/click.mp3" preload="auto"></audio>
            <audio id="fall-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/boing.mp3" preload="auto"></audio>
        </a-assets>

        <!-- Se ha añadido una entidad invisible para el sonido de disparo y caída. -->
        <a-entity id="shot-sound-player" sound="src: #shot-sound; volume: 0.5;"></a-entity>
        <a-entity id="fall-sound-player" sound="src: #fall-sound; volume: 0.8;"></a-entity>

        <!-- Cámara del jugador. -->
        <a-entity id="rig" movement-controls position="0 1.6 0">
            <!-- El raycaster detecta cualquier elemento con la clase 'clickable'. -->
            <a-entity camera look-controls cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 100;"></a-entity>
            
            <!-- Simulación del "pistola" del controlador. -->
            <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 100;" line="color: blue; opacity: 0.5"></a-entity>
        </a-entity>
        
        <!-- Entorno. -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4"></a-plane>
        <a-sky color="#ECECEC"></a-sky>

    </a-scene>
</body>
</html>
