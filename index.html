<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebXR Shooter Mejorado</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent('game-logic', {
      schema: {
        targetSpeed: {type: 'number', default: 1}
      },
      init: function () {
        this.score = 0;
        this.targets = [];
        this.missedCount = 0;
        this.maxMissed = 5;
        this.isGameOver = false;
        this.spawnInterval = 2000; // ms
        this.minSpawnInterval = 700;
        this.spawnTimer = null;

        this.createScoreboard();
        this.createMissedCounter();
        this.createStartButton();
        this.createFlash();

        this.el.sceneEl.addEventListener('click', this.handleInteraction.bind(this));
      },

      handleInteraction: function (evt) {
        this.el.sceneEl.querySelector('#shot-sound-player').components.sound.playSound();
        this.flash();

        if (this.isGameOver) return;

        if (evt.detail.intersection) {
          const el = evt.detail.intersection.object.el;

          if (el.id === 'startButton') {
            this.startGame();
          } else if (el.classList.contains('target')) {
            this.onTargetHit(el);
          } else if (el.id === 'restartButton') {
            this.restartGame();
          }
        }
      },

      createStartButton: function () {
        const button = document.createElement('a-entity');
        button.setAttribute('id', 'startButton');
        button.setAttribute('geometry', 'primitive: plane; width: 1.2; height: 0.5');
        button.setAttribute('material', 'color: green');
        button.setAttribute('position', '0 1.5 -3');
        button.setAttribute('text', 'value: ¡Empezar!; align: center; color: white; width: 3');
        button.classList.add('clickable');
        this.el.sceneEl.appendChild(button);
      },

      createFlash: function () {
        const flash = document.createElement('a-plane');
        flash.setAttribute('id', 'flash');
        flash.setAttribute('color', 'white');
        flash.setAttribute('position', '0 1.6 -0.5');
        flash.setAttribute('width', '0.2');
        flash.setAttribute('height', '0.2');
        flash.setAttribute('visible', 'false');
        this.el.sceneEl.appendChild(flash);
      },

      flash: function () {
        const flash = document.getElementById('flash');
        flash.setAttribute('visible', 'true');
        setTimeout(() => flash.setAttribute('visible', 'false'), 100);
      },

      startGame: function () {
        document.getElementById('startButton').setAttribute('visible', 'false');
        this.isGameOver = false;
        this.score = 0;
        this.missedCount = 0;
        this.spawnInterval = 2000;
        this.updateScoreboard();
        this.updateMissedCounter();

        this.scheduleTargetSpawn();
      },

      scheduleTargetSpawn: function () {
        if (this.spawnTimer) clearInterval(this.spawnTimer);
        this.spawnTimer = setInterval(() => {
          if (!this.isGameOver) {
            this.createTarget();
            if (this.spawnInterval > this.minSpawnInterval) {
              this.spawnInterval -= 100; // dificultad aumenta
              this.scheduleTargetSpawn();
            }
          }
        }, this.spawnInterval);
      },

      createTarget: function () {
        const target = document.createElement('a-entity');
        target.setAttribute('geometry', 'primitive: circle; radius: 0.35');
        target.setAttribute('material', 'src: #target-texture; side: double');
        target.setAttribute('position', {x: (Math.random() - 0.5) * 4, y: 0.5, z: -20});
        target.setAttribute('class', 'target clickable');
        target.setAttribute('target-movement', 'speed: ' + this.data.targetSpeed);
        target.setAttribute('sound', 'src: #hit-sound; on: target-hit;');
        target.setAttribute('animation__spin', 'property: rotation; to: 0 360 0; loop: true; dur: 2000');

        this.targets.push(target);
        this.el.sceneEl.appendChild(target);
      },

      updateScoreboard: function () {
        document.getElementById('scoreboard').setAttribute('text', 'value', 'Puntuación: ' + this.score);
      },

      updateMissedCounter: function () {
        document.getElementById('missedCounter').setAttribute('text', 'value', 'Fallos: ' + this.missedCount + ' / ' + this.maxMissed);
      },

      createScoreboard: function () {
        const board = document.createElement('a-entity');
        board.setAttribute('id', 'scoreboard');
        board.setAttribute('text', 'value: Puntuación: 0; align: center; width: 5');
        board.setAttribute('position', '0 2 -3');
        this.el.sceneEl.appendChild(board);
      },

      createMissedCounter: function () {
        const counter = document.createElement('a-entity');
        counter.setAttribute('id', 'missedCounter');
        counter.setAttribute('text', 'value: Fallos: 0 / ' + this.maxMissed + '; align: center; width: 5; color: yellow');
        counter.setAttribute('position', '0 1.8 -3');
        this.el.sceneEl.appendChild(counter);
      },

      onTargetHit: function (el) {
        el.emit('target-hit');
        el.setAttribute('animation__scale', 'property: scale; to: 0 0 0; dur: 200');
        setTimeout(() => el.remove(), 200);
        this.score += 100;
        this.updateScoreboard();
      },

      tick: function () {
        if (this.isGameOver) return;
        this.targets.forEach(t => {
          const pos = t.getAttribute('position');
          if (pos.z > 2) {
            this.el.sceneEl.querySelector('#fall-sound-player').components.sound.playSound();
            this.missedCount++;
            this.updateMissedCounter();
            t.remove();
            if (this.missedCount >= this.maxMissed) this.endGame();
          }
        });
        this.targets = this.targets.filter(t => t.parentNode);
      },

      endGame: function () {
        this.isGameOver = true;
        clearInterval(this.spawnTimer);

        const text = document.createElement('a-entity');
        text.setAttribute('id', 'gameOverText');
        text.setAttribute('text', `value: ¡Fin del juego!\nPuntuación final: ${this.score}; align: center; width: 5; color: white`);
        text.setAttribute('position', '0 1.5 -3');
        this.el.sceneEl.appendChild(text);

        setTimeout(() => {
          const restart = document.createElement('a-entity');
          restart.setAttribute('id', 'restartButton');
          restart.setAttribute('geometry', 'primitive: plane; width: 1.5; height: 0.5');
          restart.setAttribute('material', 'color: blue');
          restart.setAttribute('position', '0 1 -3');
          restart.setAttribute('text', 'value: Volver a empezar; align: center; color: white; width: 3');
          restart.classList.add('clickable');
          this.el.sceneEl.appendChild(restart);
        }, 1500);
      },

      restartGame: function () {
        // limpiar entidades extra
        document.querySelectorAll('.target').forEach(t => t.remove());
        const gameOverText = document.getElementById('gameOverText');
        const restartBtn = document.getElementById('restartButton');
        if (gameOverText) gameOverText.remove();
        if (restartBtn) restartBtn.remove();

        document.getElementById('startButton').setAttribute('visible', 'true');
      }
    });

    AFRAME.registerComponent('target-movement', {
      schema: { speed: {type: 'number', default: 1} },
      init: function () {
        this.initialPos = this.el.getAttribute('position').clone();
        this.elapsedTime = 0;
      },
      tick: function (time, dt) {
        this.elapsedTime += dt / 1000;
        const y = this.initialPos.y + (this.elapsedTime * this.data.speed * 5) - (0.5 * 0.98 * this.elapsedTime * this.elapsedTime);
        const z = this.initialPos.z + (this.elapsedTime * this.data.speed * 0.3);
        this.el.setAttribute('position', {x: this.initialPos.x, y, z});
      }
    });
  </script>
</head>
<body>
  <a-scene game-logic>
    <a-assets>
      <audio id="shot-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/gun.mp3" preload="auto"></audio>
      <audio id="hit-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/click.mp3" preload="auto"></audio>
      <audio id="fall-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/boing.mp3" preload="auto"></audio>
      <img id="target-texture" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Archery_target_80cm.svg/512px-Archery_target_80cm.svg.png">
    </a-assets>

    <a-entity id="shot-sound-player" sound="src: #shot-sound; volume: 0.5;"></a-entity>
    <a-entity id="fall-sound-player" sound="src: #fall-sound; volume: 0.8;"></a-entity>

    <a-entity id="rig" position="0 1.6 0">
      <a-entity camera look-controls cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 100;"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 100;" line="color: blue; opacity: 0.5"></a-entity>
    </a-entity>

    <a-plane position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4"></a-plane>
    <a-sky color="#ECECEC"></a-sky>
  </a-scene>
</body>
</html>
