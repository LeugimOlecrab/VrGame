<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebXR Shooter Mejorado - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent('game-logic', {
      schema: {
        targetSpeed: {type: 'number', default: 1}
      },
      init: function () {
        this.score = 0;
        this.targets = [];
        this.missedCount = 0;
        this.maxMissed = 5;
        this.isGameOver = false;
        this.spawnInterval = 2000;
        this.minSpawnInterval = 700;
        this.spawnTimer = null;

        this.createScoreboard();
        this.createMissedCounter();
        this.createStartButton();
        this.createFlash();
        this.createMobileInstructions();

        // Soporte para clics y toques
        this.el.sceneEl.addEventListener('click', this.handleInteraction.bind(this));
        this.el.sceneEl.addEventListener('touchstart', this.handleInteraction.bind(this));
      },

      handleInteraction: function (evt) {
        this.el.sceneEl.querySelector('#shot-sound-player').components.sound.playSound();
        this.flash();

        if (this.isGameOver) return;

        // Obtener el elemento intersectado (si existe)
        let intersectedEl = null;
        if (evt.detail.intersection) {
          intersectedEl = evt.detail.intersection.object.el; // Para clics
        } else if (evt.detail.target && evt.detail.target.classList.contains('clickable')) {
          intersectedEl = evt.detail.target; // Para toques
        }

        if (intersectedEl) {
          if (intersectedEl.id === 'startButton') {
            this.startGame();
          } else if (intersectedEl.classList.contains('target')) {
            this.onTargetHit(intersectedEl);
          } else if (intersectedEl.id === 'restartButton') {
            this.restartGame();
          }
        }
      },

      createStartButton: function () {
        const button = document.createElement('a-entity');
        button.setAttribute('id', 'startButton');
        button.setAttribute('geometry', 'primitive: plane; width: 1; height: 0.4');
        button.setAttribute('material', 'color: green');
        button.setAttribute('position', '0 1.5 -2'); // Más cerca en móviles
        button.setAttribute('text', 'value: ¡Empezar!; align: center; color: white; width: 2');
        button.classList.add('clickable');
        this.el.sceneEl.appendChild(button);
      },

      createFlash: function () {
        const flash = document.createElement('a-plane');
        flash.setAttribute('id', 'flash');
        flash.setAttribute('color', 'white');
        flash.setAttribute('position', '0 0 -0.5'); // Relativo a la cámara
        flash.setAttribute('width', '0.15');
        flash.setAttribute('height', '0.15');
        flash.setAttribute('visible', 'false');
        this.el.sceneEl.querySelector('#rig').appendChild(flash); // Adjunto al rig
      },

      flash: function () {
        const flash = document.getElementById('flash');
        flash.setAttribute('visible', 'true');
        setTimeout(() => flash.setAttribute('visible', 'false'), 100);
      },

      createMobileInstructions: function () {
        const instructions = document.createElement('a-entity');
        instructions.setAttribute('id', 'instructions');
        instructions.setAttribute('text', 'value: Mueve tu teléfono para apuntar\nToca la pantalla para disparar; align: center; width: 2; color: white');
        instructions.setAttribute('position', '0 1.2 -2');
        this.el.sceneEl.appendChild(instructions);
      },

      startGame: function () {
        document.getElementById('startButton').setAttribute('visible', 'false');
        document.getElementById('instructions').setAttribute('visible', 'false');
        this.isGameOver = false;
        this.score = 0;
        this.missedCount = 0;
        this.spawnInterval = 2000;
        this.updateScoreboard();
        this.updateMissedCounter();

        this.scheduleTargetSpawn();
      },

      scheduleTargetSpawn: function () {
        if (this.spawnTimer) clearInterval(this.spawnTimer);
        this.spawnTimer = setInterval(() => {
          if (!this.isGameOver && this.targets.length < 8) { // Límite para móviles
            this.createTarget();
            if (this.spawnInterval > this.minSpawnInterval) {
              this.spawnInterval -= 100;
              this.scheduleTargetSpawn();
            }
          }
        }, this.spawnInterval);
      },

      createTarget: function () {
        const target = document.createElement('a-entity');
        target.setAttribute('geometry', 'primitive: circle; radius: 0.3'); // Más pequeño para móviles
        target.setAttribute('material', 'src: #target-texture; side: double');
        target.setAttribute('position', {x: (Math.random() - 0.5) * 3, y: 0.5, z: -15}); // Menos dispersión
        target.setAttribute('class', 'target clickable');
        target.setAttribute('target-movement', 'speed: ' + this.data.targetSpeed);
        target.setAttribute('sound', 'src: #hit-sound; on: target-hit;');
        target.setAttribute('animation__spin', 'property: rotation; to: 0 360 0; loop: true; dur: 2000');

        this.targets.push(target);
        this.el.sceneEl.appendChild(target);
      },

      updateScoreboard: function () {
        document.getElementById('scoreboard').setAttribute('text', 'value: Puntuación: ' + this.score + '; width: 3');
      },

      updateMissedCounter: function () {
        document.getElementById('missedCounter').setAttribute('text', 'value: Fallos: ' + this.missedCount + ' / ' + this.maxMissed + '; width: 3');
      },

      createScoreboard: function () {
        const board = document.createElement('a-entity');
        board.setAttribute('id', 'scoreboard');
        board.setAttribute('text', 'value: Puntuación: 0; align: center; width: 3; color: white');
        board.setAttribute('position', '0 1.8 -2');
        this.el.sceneEl.appendChild(board);
      },

      createMissedCounter: function () {
        const counter = document.createElement('a-entity');
        counter.setAttribute('id', 'missedCounter');
        counter.setAttribute('text', 'value: Fallos: 0 / ' + this.maxMissed + '; align: center; width: 3; color: yellow');
        counter.setAttribute('position', '0 1.6 -2');
        this.el.sceneEl.appendChild(counter);
      },

      onTargetHit: function (el) {
        el.emit('target-hit');
        el.setAttribute('animation__scale', 'property: scale; to: 0 0 0; dur: 200');
        setTimeout(() => el.remove(), 200);
        this.score += 100;
        this.updateScoreboard();
      },

      tick: function () {
        if (this.isGameOver) return;
        this.targets = this.targets.filter(t => {
          if (!t.parentNode) return false;
          const pos = t.getAttribute('position');
          if (pos.z > 2) {
            this.el.sceneEl.querySelector('#fall-sound-player').components.sound.playSound();
            this.missedCount++;
            this.updateMissedCounter();
            t.remove();
            if (this.missedCount >= this.maxMissed) this.endGame();
            return false;
          }
          return true;
        });
      },

      endGame: function () {
        this.isGameOver = true;
        clearInterval(this.spawnTimer);

        const text1 = document.createElement('a-entity');
        text1.setAttribute('id', 'gameOverText1');
        text1.setAttribute('text', 'value: ¡Fin del juego!; align: center; width: 3; color: white');
        text1.setAttribute('position', '0 1.7 -2');
        this.el.sceneEl.appendChild(text1);

        const text2 = document.createElement('a-entity');
        text2.setAttribute('id', 'gameOverText2');
        text2.setAttribute('text', `value: Puntuación final: ${this.score}; align: center; width: 3; color: white`);
        text2.setAttribute('position', '0 1.3 -2');
        this.el.sceneEl.appendChild(text2);

        setTimeout(() => {
          const restart = document.createElement('a-entity');
          restart.setAttribute('id', 'restartButton');
          restart.setAttribute('geometry', 'primitive: plane; width: 1; height: 0.4');
          restart.setAttribute('material', 'color: blue');
          restart.setAttribute('position', '0 1 -2');
          restart.setAttribute('text', 'value: Volver a empezar; align: center; color: white; width: 2');
          restart.classList.add('clickable');
          this.el.sceneEl.appendChild(restart);
        }, 1500);
      },

      restartGame: function () {
        this.targets.forEach(t => t.remove());
        this.targets = [];
        clearInterval(this.spawnTimer);
        document.querySelectorAll('.target').forEach(t => t.remove());
        const gameOverText1 = document.getElementById('gameOverText1');
        const gameOverText2 = document.getElementById('gameOverText2');
        const restartBtn = document.getElementById('restartButton');
        if (gameOverText1) gameOverText1.remove();
        if (gameOverText2) gameOverText2.remove();
        if (restartBtn) restartBtn.remove();
        document.getElementById('startButton').setAttribute('visible', 'true');
        document.getElementById('instructions').setAttribute('visible', 'true');
      }
    });

    AFRAME.registerComponent('target-movement', {
      schema: { speed: {type: 'number', default: 1} },
      init: function () {
        this.initialPos = this.el.getAttribute('position').clone();
        this.elapsedTime = 0;
      },
      tick: function (time, dt) {
        this.elapsedTime += dt / 1000;
        const y = this.initialPos.y + (this.elapsedTime * this.data.speed * 5) - (0.5 * 0.98 * this.elapsedTime * this.elapsedTime);
        const z = this.initialPos.z + (this.elapsedTime * this.data.speed * 0.3);
        this.el.setAttribute('position', {x: this.initialPos.x, y, z});
      }
    });
  </script>
</head>
<body>
  <a-scene game-logic vr-mode-ui="enabled: true">
    <a-assets>
      <audio id="shot-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/gun.mp3" preload="auto"></audio>
      <audio id="hit-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/click.mp3" preload="auto"></audio>
      <audio id="fall-sound" src="https://cdn.jsdelivr.net/gh/aframevr/aframe/examples/showcase/audio/boing.mp3" preload="auto"></audio>
      <img id="target-texture" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Archery_target_80cm.svg/512px-Archery_target_80cm.svg.png">
    </a-assets>

    <a-entity id="shot-sound-player" sound="src: #shot-sound; volume: 0.5;"></a-entity>
    <a-entity id="fall-sound-player" sound="src: #fall-sound; volume: 0.8;"></a-entity>

    <a-entity id="rig" position="0 1.6 0">
      <a-entity camera look-controls="magicWindowTracking: true" cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable; far: 100;">
        <!-- Punto central para móviles -->
        <a-entity geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015" material="color: red" position="0 0 -1"></a-entity>
      </a-entity>
    </a-entity>

    <a-plane position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4"></a-plane>
    <a-sky color="#ECECEC"></a-sky>
  </a-scene>
</body>
</html>
